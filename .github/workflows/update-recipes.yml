name: Update content
run-name: ${{ github.actor }} updating recipes üöÄ

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  repository_dispatch:
    types: [update_content]

# Prevent multiple runs from racing against each other on master
concurrency:
  group: update-content-master
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1Ô∏è‚É£ Checkout full history
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      # 3Ô∏è‚É£ Cache pip dependencies
      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('scripts/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4Ô∏è‚É£ Install Python dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade-strategy only-if-needed flake8 pytest
          if [ -f scripts/requirements.txt ]; then pip install --upgrade-strategy only-if-needed -r scripts/requirements.txt; fi

      # 5Ô∏è‚É£ Sync with latest master
      - name: Sync with latest master
        run: |
          git fetch origin master
          git rebase origin/master

      # 6Ô∏è‚É£ Generate content
      - name: Execute Python script
        run: |
          python scripts/import_recipes.py --output-dir ./astro/src/content/recipes/

      # 7Ô∏è‚É£ Commit updates if any
      - name: Commit updates
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Automated Change

      # 8Ô∏è‚É£ Setup Node 22 for Astro
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      # 9Ô∏è‚É£ Install pnpm
      - name: Install pnpm
        run: npm install -g pnpm

      # üîü Cache pnpm dependencies
      - name: Cache pnpm
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      # 1Ô∏è‚É£1Ô∏è‚É£ Install Node dependencies
      - name: Install Node dependencies
        run: pnpm install
        working-directory: ./astro

      # 1Ô∏è‚É£2Ô∏è‚É£ Build Astro site
      - name: Build Astro site
        run: pnpm run build
        working-directory: ./astro

      # Optional: check that dist exists
      - name: Check build output
        run: ls -la ./astro/dist

      # 1Ô∏è‚É£3Ô∏è‚É£ Deploy to Cloudflare Pages
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: >
            pages deploy ./astro/dist
            --project-name=burnbook-astro-frontend

      # 1Ô∏è‚É£4Ô∏è‚É£ Purge Cloudflare cache (curl-based, fixes workflow validation)
      - name: Purge Cloudflare cache
        run: |
          curl -X POST \
            "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}'
