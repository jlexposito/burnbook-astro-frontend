name: Update content
run-name: ${{ github.actor }} updating recipes üöÄ

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  repository_dispatch:
    types: [update_content]

# Prevent multiple runs from racing against each other on master
concurrency:
  group: update-content-master
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1Ô∏è‚É£ Checkout full history
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
          cache: pip

      # 3Ô∏è‚É£ Install Python dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest
          if [ -f scripts/requirements.txt ]; then pip install -r scripts/requirements.txt; fi

      # 4Ô∏è‚É£ Sync with latest master
      - name: Sync with latest master
        run: |
          git fetch origin master
          git rebase origin/master

      # 5Ô∏è‚É£ Generate content
      - name: Execute Python script
        run: |
          python scripts/import_recipes.py --output-dir ./astro/src/content/recipes/

      # 6Ô∏è‚É£ Commit updates if any
      - name: Commit updates
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Automated Change

      # 7Ô∏è‚É£ Setup Node for Astro
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 8Ô∏è‚É£ Install Node dependencies
      - name: Install Node dependencies
        run: npm ci
        working-directory: ./astro

      # 9Ô∏è‚É£ Build Astro site
      - name: Build Astro site
        run: npm run build
        working-directory: ./astro

      # Optional: check that dist exists
      - name: Check build output
        run: ls -la ./astro/dist

      # üîü Deploy to Cloudflare Pages
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: >
            pages deploy ./astro/dist
            --project-name=burnbook-astro-frontend

      # 1Ô∏è‚É£1Ô∏è‚É£ Purge cache
      - name: Purge Cloudflare cache
        uses: jakejarvis/cloudflare-purge-action@master
        env:
          CLOUDFLARE_ZONE: ${{ secrets.CLOUDFLARE_ZONE }}
          CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}
